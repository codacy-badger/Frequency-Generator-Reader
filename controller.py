#!/usr/bin/python
"""
 **File Name:** controller.py                                                                    \n
 **Project:** CURRENTLY UNNAMED                                                                  \n
 **Company:** Research in Flows, Inc                                                             \n
 **Author:** David A. Gurevich                                                                   \n

"Lasciate ogne speranza, voi ch'entrate"
    - Inferno (Dante)

Frequency-Generator Reader | Local software for generating and processing high-frequency signals
Copyright (C) 2018  David A. Gurevich
"""

import os
import sys
from time import gmtime, strftime

from flask import Flask, render_template, request

from scanner.IPDetector import get_local_ip
from scanner.model import InputForm
from scanner.plot import create_figure
from scanner.run_scan import run_scan
from scanner.string_tool import to_hz, to_volts, print_scan
from scanner.write_csv import zip_folder

if getattr(sys, 'frozen', False):
    template_folder = os.path.join(sys._MEIPASS, 'templates')
    static_folder = os.path.join(sys.executable, '..', 'static')
    app = Flask(__name__, template_folder=template_folder)
else:
    app = Flask(__name__)

process_running = False
scan_parameters_dict = None


@app.route('/', methods=['GET', 'POST'])
def index():
    """
    Page to be loaded when user connects to host:5000/

    Attr:
        form: Class from model.py -- Contains input forms for scan information.
        zip_file: Zip file generated by bin_to_csv.py containing data files.
        png_img: base64 encoded PNG image of graphed data.
    """
    global process_running
    global scan_parameters_dict

    if not process_running:
        form = InputForm(request.form)
        plots = []
        zip_file = None

        if request.method == 'POST' and form.validate():
            process_running = True  # To prevent further connections

            scan_parameters = (form.fq.data,
                               form.amp.data,
                               form.rate.data,
                               form.dur.data,
                               form.thread_count.data)

            scan_parameters_dict = {
                "Frequency": to_hz(form.fq.data),
                "Amplitude": to_volts(form.amp.data),
                "Scan Rate": to_hz(form.rate.data),
                "Scan Duration": str(form.dur.data) + " second(s)",
                "Thread Count": int(form.thread_count.data),
                "Initialization Time": strftime("%Y-%m-%d %H:%M:%S", gmtime()),
                "Graph Data?": str(form.graph_data.data)
            }

            print_scan(scan_parameters_dict)

            # Initialize and run scan. Get completion status (True / False) and list of errors
            scan_completed, scan_errors = run_scan(scan_parameters)

            # If scan was successfully completed, Create zip folder and graph data if required
            if scan_completed:
                zip_file = zip_folder()
                if form.graph_data.data:  # Graph Data?
                    plots.append(create_figure())

                process_running = False
                return render_template('index.html', form=form, result=zip_file, plots=plots)
            else:  # If scan was NOT successfully completed, return error page with scan errors
                process_running = False
                return render_template('500.html', exception_message="<br /> - ".join(scan_errors), data_type=str)
        elif form.errors != {} and not form.validate():  # If form was NOT valid
            return render_template('500.html', exception_message=form.errors, data_type=str(type(form.errors)))

        return render_template('index.html', form=form, result=zip_file, plots=plots)

    else:  # If a process was running
        return render_template('refused.html', scan_data=scan_parameters_dict)


@app.route('/refusedtest')
def refuse_connection(scan_parameters_dict={"Test": "No Parameters here! This is a test page!"}):
    return render_template('refused.html', scan_data=scan_parameters_dict)


@app.route('/errortest')
def error_page(obj="This is a test error message"):
    return render_template('500.html', exception_message=obj, data_type=type(obj))


@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html')


if __name__ == '__main__':
    app.run(debug=True, host=get_local_ip(), port=5000)
